name: Build, Test, and Coverage

on:
  push:
    branches: [main, develop]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build-test:
    name: Build, Test, and Report Coverage
    runs-on: macos-latest
    strategy:
      matrix:
        xcode: [16.2] # Add more versions as needed

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up latest Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ matrix.xcode }}.app

      - name: Build and run tests with coverage
        run: |
          set -e
          cd Sample
          xcodebuild test \
            -scheme Sample \
            -destination 'platform=macOS' \
            -enableCodeCoverage YES
          mkdir -p coverage
          cp -R ~/Library/Developer/Xcode/DerivedData/*/Logs/Test/*.xcresult coverage/

      - name: Download xccov-to-lcov (alternative fork)
        run: |
          curl -L -o /usr/local/bin/xccov-to-lcov https://raw.githubusercontent.com/DreaminginCodeZH/xccov-to-lcov/master/xccov-to-lcov
          chmod +x /usr/local/bin/xccov-to-lcov

      - name: Verify xccov-to-lcov download
        run: head -20 /usr/local/bin/xccov-to-lcov
        
      - name: Convert Coverage to lcov
        run: |
          cd Sample
          XCRESULT=$(ls -td ~/Library/Developer/Xcode/DerivedData/*/Logs/Test/*.xcresult | head -n1)
          xccov-to-lcov --xcresult $XCRESULT > coverage.lcov

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: Sample/coverage.lcov

      - name: Post coverage to PR
        uses: romeovs/lcov-reporter-action@v0.3.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          lcov-file: Sample/coverage.lcov
        if: github.event_name == 'pull_request'
